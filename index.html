<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0f1220" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="TradeFocus">
  <link rel="manifest" href="manifest.webmanifest">
  <title>TradeFocus — App (Fixed)</title>
  <style>
    :root{
      --bg:#0f1220; --panel:#171a2a; --panel-2:#1f2340; --text:#e8ebff; --muted:#a9b0d6;
      --accent:#6c8cff; --accent-2:#4fe3c1; --danger:#ff6b6b; --warn:#ffd166;
      --ok:#7ae582; --border:#2a3057; --chip:#262b55; --shadow:0 6px 22px rgba(0,0,0,.35);
      --radius:16px;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
      --tabbar-h: 64px;
    }
    /* Reset & base */
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    html,body{height:100%}
    body{
      margin:0; font-family: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(1200px 900px at 15% 5%, #1b1f37 0%, #0f1220 40%, #0f1220 100%);
      color:var(--text);
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .app{
      height: 100svh; /* better on iOS than 100vh/dvh */
      display:flex; flex-direction:column;
    }
    header.appbar{
      position:sticky; top:0; z-index:10;
      padding: calc(8px + var(--safe-top)) 16px 8px 16px;
      background: linear-gradient(180deg, rgba(15,18,32,.98) 0%, rgba(15,18,32,.82) 100%);
      border-bottom: 1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      backdrop-filter: blur(8px);
    }
    .brand{display:flex; gap:10px; align-items:center; min-height:40px}
    .logo{width:26px; height:26px; border-radius:8px; background:linear-gradient(135deg, var(--accent), var(--accent-2)); box-shadow:0 6px 18px rgba(108,140,255,.4)}
    .brand h1{font-size:18px; margin:0}
    .install-btn{background:#252a52; color:#cad1ff; border:1px solid var(--border); padding:8px 12px; border-radius:999px; font-size:12px}
    main{flex:1; min-height:0; display:grid; grid-template-rows:1fr; padding-bottom: calc(var(--tabbar-h) + var(--safe-bottom));}
    .screen{height:100%; overflow:auto; padding:12px 12px 24px 12px; -webkit-overflow-scrolling: touch;}
    .hidden{display:none !important}
    .card{background:linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); margin-bottom:12px}
    .card h2{margin:0; font-size:15px; padding:12px 12px; border-bottom:1px solid var(--border); color:#cfd6ff; position:sticky; top:0; background:linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%); z-index:1}
    .card .body{padding:12px}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .row-3{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
    .row-4{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
    @media (max-width: 520px){
      .row, .row-3, .row-4{grid-template-columns:1fr}
    }
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input, select, textarea{
      width:100%; padding:14px 12px; border-radius:12px; border:1px solid var(--border);
      background:#0e1122; color:#e8ebff; outline:none; font-size:16px;
      -webkit-appearance: none; appearance: none;
    }
    textarea{min-height:72px; resize:vertical}
    input::placeholder{color:#6f76a5}
    .help{font-size:12px; color:#9aa2d0}
    .tools{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px}
    button{
      appearance:none; border:none; padding:12px 14px; border-radius:12px; cursor:pointer;
      background:var(--accent); color:#fff; font-weight:700; box-shadow:0 4px 16px rgba(108,140,255,.35); font-size:15px;
      min-height:44px;
    }
    button.secondary{background:#252a52; color:#cad1ff; box-shadow:none; border:1px solid var(--border)}
    button.ghost{background:transparent; color:#cad1ff; border:1px dashed var(--border)}
    button.warn{background:var(--danger)}
    button:active{transform: translateY(1px)}
    .switch{display:flex; gap:8px; background:#0e1230; border:1px solid var(--border); padding:6px; border-radius:12px; width:max-content}
    .switch button{padding:8px 12px; background:transparent; box-shadow:none; color:#b8c1ff; font-weight:600}
    .switch button.active{background:var(--accent); color:white; border-radius:8px}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; background:#121633; border:1px solid var(--border); color:#cdd3ff; font-size:12px}
    .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:6px}
    .chip{background:#10163b; border:1px solid var(--border); padding:8px 10px; border-radius:10px; font-size:12px; color:#cdd3ff; cursor:pointer}
    .tp-list{display:flex; flex-direction:column; gap:10px}
    .tp-row{display:grid; grid-template-columns:1fr auto; gap:8px}
    .tp-row .actions{display:flex; gap:8px}
    .error{color:var(--danger); font-size:13px; margin-top:6px}
    .promptbar{
      position:sticky; bottom:8px; left:0; right:0; margin-top:8px;
      background:#0d1030d9; border:1px solid var(--border); backdrop-filter: blur(6px);
      border-radius:12px; padding:12px; display:none; gap:10px; align-items:center; justify-content:space-between;
    }
    /* Bottom nav (fixed + safe-area) */
    nav.tabbar{
      position:fixed; bottom:0; left:0; right:0; z-index:15;
      background: linear-gradient(180deg, rgba(15,18,32,.95) 0%, rgba(15,18,32,1) 100%);
      border-top: 1px solid var(--border);
      padding: 6px 10px calc(6px + var(--safe-bottom));
      display:grid; grid-template-columns:repeat(3,1fr); gap:10px;
      height: calc(var(--tabbar-h) + var(--safe-bottom));
      box-sizing: content-box;
    }
    .tabbtn{
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;
      color:#b9c2ff; background:#0f1436; border:1px solid var(--border);
      border-radius:12px; padding:8px 6px; font-size:12px; font-weight:700; min-height:44px;
    }
    .tabbtn.active{background:linear-gradient(135deg, #1a2355, #15224a); color:#fff; border-color:#39407a}
    .tabbtn .dot{width:6px; height:6px; border-radius:999px; background:#3e4aa0}
    .tabbtn.active .dot{background:var(--accent-2)}
    /* Table responsiveness */
    .table-wrap{overflow:auto; -webkit-overflow-scrolling:touch}
    table{width:100%; border-collapse:separate; border-spacing:0; font-size:14px; min-width:720px}
    th,td{padding:10px 8px; border-bottom:1px dashed var(--border); text-align:right; background:transparent}
    th:first-child, td:first-child{text-align:left; position:sticky; left:0; background:linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);}
    th{font-weight:600; color:#cfd6ff; position:sticky; top:0; background:linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%); z-index:2}
    .nowrap{white-space:nowrap}
    /* Focus visibility for accessibility */
    :focus-visible{outline:2px solid var(--accent-2); outline-offset:2px; border-radius:10px}
    /* Small phones tweaks */
    @media (max-width:360px){
      .brand h1{font-size:16px}
      .tabbtn{font-size:11px}
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="appbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>TradeFocus</h1>
      </div>
      <div class="switch" role="tablist" aria-label="Position side">
        <button id="btnLong" class="active" aria-selected="true">Long</button>
        <button id="btnShort" aria-selected="false">Short</button>
      </div>
      <button id="btnInstall" class="install-btn" style="display:none">Cài đặt</button>
    </header>

    <main>
      <!-- Screen: Calculator -->
      <section id="scrCalc" class="screen">
        <div class="card">
          <h2>Thông số vào lệnh</h2>
          <div class="body">
            <div class="row">
              <div>
                <label for="symbol">Tên Coin</label>
                <input id="symbol" type="text" placeholder="vd: BTCUSDT, ETHUSDT" maxlength="20">
              </div>
              <div>
                <label for="margin">Tiền ký quỹ (M)</label>
                <input id="margin" type="number" inputmode="decimal" placeholder="vd: 100" min="0" step="any">
              </div>
            </div>
            <div class="row">
              <div>
                <label for="entry">Giá vào lệnh (E)</label>
                <input id="entry" type="number" inputmode="decimal" placeholder="vd: 10" min="0" step="any">
              </div>
              <div>
                <label for="stop">Giá dừng lỗ (SL)</label>
                <input id="stop" type="number" inputmode="decimal" placeholder="vd: 9 (Long) / 11 (Short)" min="0" step="any">
              </div>
            </div>
            <div class="row">
              <div>
                <label for="lev">Đòn bẩy (L) <span class="muted">(tuỳ chọn nếu đã nhập R)</span></label>
                <input id="lev" type="number" inputmode="decimal" placeholder="vd: 5" min="0" step="any">
              </div>
              <div>
                <label for="risk">Tiền chịu lỗ (R) <span class="muted">(tuỳ chọn nếu đã nhập L hoặc Q)</span></label>
                <input id="risk" type="number" inputmode="decimal" placeholder="vd: 20" min="0" step="any">
              </div>
            </div>
            <div class="row">
              <div>
                <label for="qty">Khối lượng (Q) <span class="muted">(tự tính, có thể ghi đè)</span></label>
                <input id="qty" type="number" inputmode="decimal" placeholder="auto" min="0" step="any">
              </div>
              <div class="chips">
                <span class="chip" data-fill="tp:0.5">TP = E ± 0.5×ΔSL</span>
                <span class="chip" data-fill="tp:1">TP = E ± 1×ΔSL</span>
                <span class="chip" data-fill="tp:2">TP = E ± 2×ΔSL</span>
              </div>
            </div>

            <div class="tp-list" id="tpList" aria-live="polite" style="margin-top:6px">
              <label>Giá chốt lời TP (có thể để trống)</label>
              <div class="tp-row">
                <input class="tp" type="number" inputmode="decimal" placeholder="TP1" step="any">
                <div class="actions">
                  <button class="secondary" id="addTP" type="button">+ TP</button>
                  <button class="ghost" id="clearTP" type="button">Xoá TP</button>
                </div>
              </div>
            </div>

            <div class="tools">
              <button id="calc" type="button">Tính toán</button>
              <button id="sample" class="secondary" type="button">Ví dụ</button>
              <button id="reset" class="ghost" type="button">Reset</button>
              <span class="pill" id="consistencyPill" title="So khớp giữa L và R">Khớp L & R: <b id="consistencyTxt">—</b></span>
            </div>
            <div id="err" class="error" role="alert" aria-live="assertive"></div>

            <div id="promptAdd" class="promptbar">
              <div><b>Thêm vào Nhật ký giao dịch?</b> <span class="muted">(lưu trong thiết bị)</span></div>
              <div style="display:flex; gap:8px">
                <button id="btnAddJournal" class="secondary">Thêm</button>
                <button id="btnCancelAdd" class="ghost">Bỏ qua</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>Kết quả</h2>
          <div class="body">
            <div class="metric"><div class="t">Tỷ lệ di chuyển tới SL</div><div class="k"><span id="moveSL">—</span> <span class="muted">%</span></div></div>
            <div class="metric"><div class="t">Đòn bẩy (L)</div><div class="k" id="outLev">—</div></div>
            <div class="metric"><div class="t">Khối lượng (Q)</div><div class="k" id="outQty">—</div></div>
            <div class="metric"><div class="t">Giá trị danh nghĩa</div><div class="k"><span id="outNotional">—</span> <span class="muted">USDT</span></div></div>
            <div class="metric"><div class="t">ROI nếu chạm SL</div><div class="k bad"><span id="roiStop">—</span> <span class="muted">%</span></div></div>
            <div class="metric"><div class="t">Tiền chịu lỗ (R)</div><div class="k bad"><span id="outRisk">—</span> <span class="muted">USDT</span></div></div>

            <div class="table-wrap">
              <table id="tpTable" style="margin-top:6px; display:none">
                <thead>
                  <tr><th>TP</th><th>Di chuyển</th><th>PNL</th><th>ROI</th><th>R:R</th></tr>
                </thead>
                <tbody id="tpBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Screen: Journal -->
      <section id="scrJournal" class="screen hidden">
        <div class="card">
          <h2>Nhật ký giao dịch</h2>
          <div class="body">
            <div class="row">
              <div><label>Từ ngày</label><input id="dateFrom" type="date"></div>
              <div><label>Đến ngày</label><input id="dateTo" type="date"></div>
            </div>
            <div class="row">
              <div>
                <label>Nhóm theo</label>
                <select id="groupUnit">
                  <option value="day">Ngày</option>
                  <option value="week">Tuần</option>
                  <option value="month">Tháng</option>
                  <option value="year">Năm</option>
                </select>
              </div>
              <div style="display:flex; align-items:flex-end; gap:8px; flex-wrap:wrap">
                <button id="btnFilter" class="secondary">Lọc</button>
                <button id="btnExportCSV" class="ghost">Xuất CSV</button>
                <button id="btnExportJSON" class="ghost">Xuất JSON</button>
                <button id="btnImport" class="secondary">Nhập JSON</button>
                <input id="importFile" type="file" accept=".json" style="display:none">
              </div>
            </div>

            <div class="metric"><div class="t">Số lệnh</div><div class="k" id="sTrades">0</div></div>
            <div class="metric"><div class="t">Tỷ lệ thắng</div><div class="k" id="sWinrate">0%</div></div>
            <div class="metric"><div class="t">PNL ròng</div><div class="k" id="sNet">0</div></div>
            <div class="metric"><div class="t">Expectancy / lệnh</div><div class="k" id="sExp">0</div></div>

            <div class="table-wrap">
              <table id="journalTable" style="margin-top:6px">
                <thead>
                  <tr>
                    <th>Thời gian</th>
                    <th>Coin</th>
                    <th>Side</th>
                    <th class="nowrap">E / SL</th>
                    <th class="nowrap">Q / L</th>
                    <th>R</th>
                    <th>TPs</th>
                    <th>Kết quả</th>
                    <th>Ghi chú</th>
                    <th>Hành động</th>
                  </tr>
                </thead>
                <tbody id="journalBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Screen: About/Help (optional) -->
      <section id="scrAbout" class="screen hidden">
        <div class="card">
          <h2>Hướng dẫn nhanh</h2>
          <div class="body">
            <p>- Nhập M, E, SL và một trong L/R/Q. Bấm <b>Tính toán</b>.</p>
            <p>- Chọn <b>Thêm vào Nhật ký</b> để lưu. Dữ liệu lưu trên thiết bị.</p>
            <p>- Ở tab <b>Nhật ký</b>, bạn có thể Win/Loss/Sửa/Xoá và Xuất CSV/JSON.</p>
            <p>- App có thanh điều hướng cố định phía dưới; phần nội dung đã chừa chỗ để tránh che phủ.</p>
          </div>
        </div>
      </section>
    </main>

    <nav class="tabbar" role="tablist" aria-label="Navigation tabs">
      <button class="tabbtn active" data-tab="scrCalc" aria-selected="true">
        <div class="dot"></div><div>Tính toán</div>
      </button>
      <button class="tabbtn" data-tab="scrJournal" aria-selected="false">
        <div class="dot"></div><div>Nhật ký</div>
      </button>
      <button class="tabbtn" data-tab="scrAbout" aria-selected="false">
        <div class="dot"></div><div>Trợ giúp</div>
      </button>
    </nav>
  </div>

  <script>
    const $ = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
    const KEY_INPUTS='tf_calc_v1', KEY_JOURNAL='tf_journal_v1';

    // Tabs
    $$('.tabbtn').forEach(btn=>{
      btn.onclick=()=>{
        const id=btn.getAttribute('data-tab');
        $$('.tabbtn').forEach(b=>{ b.classList.toggle('active', b===btn); b.setAttribute('aria-selected', b===btn); });
        $$('.screen').forEach(sc=> sc.classList.toggle('hidden', sc.id!==id));
        // Scroll top for new screen
        document.getElementById(id).scrollTo({top:0, behavior:'smooth'});
      };
    });

    // Side switch
    let side=+1;
    $('#btnLong').onclick=()=> setSide(+1);
    $('#btnShort').onclick=()=> setSide(-1);
    function setSide(s){
      side=s;
      $('#btnLong').classList.toggle('active', side===+1);
      $('#btnShort').classList.toggle('active', side===-1);
      $('#btnLong').setAttribute('aria-selected', side===+1);
      $('#btnShort').setAttribute('aria-selected', side===-1);
    }

    // Helpers
    const number=v=>{ const n=parseFloat(v); return Number.isFinite(n)?n:null; }
    const fmt=(n,d=4)=> (n==null||!Number.isFinite(n))?'—': (Math.abs(n)>=1000? n.toLocaleString(undefined,{maximumFractionDigits:2}) : n.toLocaleString(undefined,{maximumFractionDigits:d}));
    function readTPs(){ return $$('.tp').map(i=>number(i.value)).filter(v=>v!==null); }
    function addTpInput(val=''){
      const row=document.createElement('div');
      row.className='tp-row';
      row.innerHTML=`<input class="tp" type="number" inputmode="decimal" placeholder="TP" step="any" value="${val}">
        <div class="actions"><button type="button" class="secondary btnDel">Xoá</button></div>`;
      $('#tpList').appendChild(row);
      $('.btnDel',row).onclick=()=> row.remove();
    }
    $('#addTP').onclick=()=> addTpInput('');
    $('#clearTP').onclick=()=> $$('.tp').forEach((el,i)=>{ if(i>0) el.closest('.tp-row').remove(); else el.value=''; });
    $('#tpList').addEventListener('input', e=>{
      if(e.target.classList.contains('tp')){
        const tps=$$('.tp'); if(tps.length && tps[tps.length-1].value!=='') addTpInput('');
      }
    });

    // Chips
    $$('.chip').forEach(ch=> ch.onclick=()=>{
      const type=ch.getAttribute('data-fill');
      const E=number($('#entry').value), SL=number($('#stop').value);
      if(!E||!SL) return;
      const dSL=Math.abs(SL-E);
      if(type.startsWith('tp:')){
        const k=parseFloat(type.split(':')[1]);
        const dir=side;
        const tp=E+dir*k*dSL;
        addTpInput(tp);
      }
    });

    // Calc
    let lastCalcSnapshot=null;
    $('#calc').onclick=calc;
    $('#sample').onclick=()=>{
      $('#symbol').value='BTCUSDT';
      $('#margin').value=100; setSide(+1);
      $('#entry').value=10; $('#stop').value=9;
      $('#risk').value=20; $('#lev').value=''; $('#qty').value='';
      $('#clearTP').click(); $$('.tp')[0].value=11; addTpInput(12);
      calc();
    };
    $('#reset').onclick=()=>{ localStorage.removeItem(KEY_INPUTS); location.reload(); };
    ['symbol','margin','entry','stop','lev','risk','qty'].forEach(id=>{
      $('#'+id).addEventListener('keydown', e=>{ if(e.key==='Enter') calc(); });
    });

    function storeInputs(){
      const data = {
        side,
        symbol: $('#symbol').value,
        margin: $('#margin').value, entry: $('#entry').value, stop: $('#stop').value,
        lev: $('#lev').value, risk: $('#risk').value, qty: $('#qty').value,
        tps: $$('.tp').map(i=>i.value)
      };
      localStorage.setItem(KEY_INPUTS, JSON.stringify(data));
    }
    function restoreInputs(){
      const raw=localStorage.getItem(KEY_INPUTS); if(!raw) return;
      try{
        const d=JSON.parse(raw);
        side=d.side??1; setSide(side);
        $('#symbol').value=d.symbol??'';
        $('#margin').value=d.margin??''; $('#entry').value=d.entry??''; $('#stop').value=d.stop??'';
        $('#lev').value=d.lev??''; $('#risk').value=d.risk??''; $('#qty').value=d.qty??'';
        // TP
        $$('.tp').forEach((el,i)=>{ if(i>0) el.closest('.tp-row').remove(); else el.value=''; });
        const arr=Array.isArray(d.tps)?d.tps:[];
        if(arr.length){ $$('.tp')[0].value=arr[0]??''; for(let i=1;i<arr.length;i++) addTpInput(arr[i]); }
      }catch(e){}
    }

    function calc(){
      $('#err').textContent='';
      const symbol=($('#symbol').value||'').trim().toUpperCase();
      const M=number($('#margin').value), E=number($('#entry').value), SL=number($('#stop').value);
      let L=number($('#lev').value), R=number($('#risk').value), Q=number($('#qty').value);
      const tps=readTPs();
      if(!M||!E||!SL){ $('#err').textContent='Vui lòng nhập tối thiểu: Ký quỹ (M), Giá vào (E), SL.'; return; }
      if(E<=0){ $('#err').textContent='Giá vào (E) phải > 0.'; return; }
      const dSL=Math.abs(SL-E); if(dSL<=0){ $('#err').textContent='SL phải khác E.'; return; }
      const moveSL=dSL/E;
      if(Q&&Q>0){ R=Q*dSL; L=(Q*E)/M; }
      else if(R&&R>0){ Q=R/dSL; L=(Q*E)/M; }
      else if(L&&L>0){ Q=(M*L)/E; R=Q*dSL; }
      else { $('#err').textContent='Nhập ít nhất một trong: L hoặc R hoặc Q.'; return; }
      const N=Q*E; const roiStopPct=-(R/M)*100;

      $('#moveSL').textContent=fmt(moveSL*100,3);
      $('#outLev').textContent=fmt(L,3);
      $('#outQty').textContent=fmt(Q,6);
      $('#outNotional').textContent=fmt(N,2);
      $('#roiStop').textContent=fmt(roiStopPct,2);
      $('#outRisk').textContent=fmt(R,2);

      $('#tpBody').innerHTML='';
      if(tps.length){
        $('#tpTable').style.display='';
        for(const tp of tps){
          const pnl=side*Q*(tp-E);
          const roi=(pnl/M)*100;
          const rr=Math.abs(tp-E)/dSL;
          const move=((tp-E)/E)*100*side;
          const tr=document.createElement('tr');
          const cls=pnl>=0?'ok':'bad';
          tr.innerHTML=`<td>${fmt(tp,6)}</td>
            <td class="${move>=0?'ok':'bad'}">${fmt(move,2)}%</td>
            <td class="${cls}">${fmt(pnl,2)} USDT</td>
            <td class="${cls}">${fmt(roi,2)}%</td>
            <td>${fmt(rr,2)} : 1</td>`;
          $('#tpBody').appendChild(tr);
        }
      } else { $('#tpTable').style.display='none'; }

      // Consistency
      let consistentTxt='—';
      const inputL=number($('#lev').value), inputR=number($('#risk').value);
      if(inputL&&inputR){
        const R_from_L=M*inputL*moveSL; const delta=Math.abs(R_from_L-inputR); const pct=(delta/inputR)*100;
        consistentTxt = pct<=1?'OK (≤1%)': (pct<=5?'Gần đúng (≤5%)':'Lệch nhiều');
      }
      $('#consistencyTxt').textContent=consistentTxt;
      $('#consistencyPill').title='Độ khớp giữa R và L theo công thức R = M × L × |SL−E|/E';

      storeInputs();

      lastCalcSnapshot={
        id:'t_'+Date.now(), ts:new Date().toISOString(), symbol, side:side===1?'Long':'Short',
        M,E,SL,L,R,Q,N, dSL, moveSLPct:moveSL*100, roiStopPct, tps, result:'', exitPrice:null, pnl:null, roi:null, rr:null, note:''
      };
      $('#promptAdd').style.display='flex';
    }

    // Journal
    function loadJournal(){ try{ return JSON.parse(localStorage.getItem(KEY_JOURNAL)||'[]'); }catch(e){ return []; } }
    function saveJournal(list){ localStorage.setItem(KEY_JOURNAL, JSON.stringify(list)); }
    function addToJournal(rec){ const list=loadJournal(); list.unshift(rec); saveJournal(list); renderJournal(); }
    $('#btnAddJournal').onclick=()=>{ if(lastCalcSnapshot){ addToJournal(lastCalcSnapshot); $('#promptAdd').style.display='none'; lastCalcSnapshot=null; } };
    $('#btnCancelAdd').onclick=()=>{ $('#promptAdd').style.display='none'; lastCalcSnapshot=null; };

    window.delTrade=id=>{ const list=loadJournal().filter(x=>x.id!==id); saveJournal(list); renderJournal(); };
    window.dupeTrade=id=>{
      const list=loadJournal(); const t=list.find(x=>x.id===id); if(!t) return;
      const c=JSON.parse(JSON.stringify(t)); c.id='t_'+Date.now(); c.ts=new Date().toISOString();
      list.unshift(c); saveJournal(list); renderJournal();
    };
    window.markRes=(id,res)=>{
      const list=loadJournal(); const t=list.find(x=>x.id===id); if(!t) return;
      t.result=res||'';
      if(res==='win'){
        const exit=(t.exitPrice!=null&&t.exitPrice!=='')?Number(t.exitPrice):(Array.isArray(t.tps)&&t.tps.length?Number(t.tps[0]):null);
        if(exit!=null && Number.isFinite(exit)){
          const pnl=(t.side==='Long'? +1 : -1)*t.Q*(exit-t.E); t.pnl=pnl; t.roi=t.M?(pnl/t.M)*100:null; t.rr=Math.abs(exit-t.E)/t.dSL;
        } else { t.pnl=null; t.roi=null; t.rr=null; }
      } else if(res==='loss'){
        t.pnl=-Math.abs(t.R); t.roi=t.M?(t.pnl/t.M)*100:null; t.rr=-1; t.exitPrice=t.side==='Long'?Math.min(t.SL,t.E):Math.max(t.SL,t.E);
      } else { t.pnl=null; t.roi=null; t.rr=null; }
      saveJournal(list); renderJournal();
    };
    window.editTrade=id=>{
      const note=prompt('Ghi chú mới (để trống để giữ nguyên):','');
      const list=loadJournal(); const t=list.find(x=>x.id===id); if(!t) return;
      if(note!==null) t.note = note || t.note;
      saveJournal(list); renderJournal();
    };

    function startOf(date, unit){
      const d=new Date(date);
      if(unit==='day'){ d.setHours(0,0,0,0); }
      if(unit==='week'){ const day=(d.getDay()+6)%7; d.setHours(0,0,0,0); d.setDate(d.getDate()-day); }
      if(unit==='month'){ d.setHours(0,0,0,0); d.setDate(1); }
      if(unit==='year'){ d.setHours(0,0,0,0); d.setMonth(0,1); }
      return d.toISOString();
    }
    function inRange(ts,from,to){
      const t=new Date(ts).getTime(); if(from && t<new Date(from).getTime()) return false;
      if(to){ const tend=new Date(to); tend.setHours(23,59,59,999); if(t>tend.getTime()) return false; }
      return true;
    }
    function calcStats(list){
      const n=list.length, wins=list.filter(x=>x.result==='win').length;
      const pnl=list.reduce((s,x)=> s + (Number(x.pnl)||0), 0);
      const exp=n? pnl/n : 0;
      $('#sTrades').textContent=n;
      $('#sWinrate').textContent=(n? (wins/n*100).toFixed(1):'0')+'%';
      $('#sNet').textContent=pnl.toFixed(2);
      $('#sExp').textContent=exp.toFixed(2);
    }
    function renderJournal(){
      const from=$('#dateFrom').value||null, to=$('#dateTo').value||null, unit=$('#groupUnit').value;
      const all=loadJournal(); const filtered=all.filter(x=> inRange(x.ts, from, to));
      calcStats(filtered);
      const body=$('#journalBody'); body.innerHTML='';
      const groups={}; for(const t of filtered){ const key=startOf(t.ts, unit); (groups[key] ||= []).push(t); }
      const keys=Object.keys(groups).sort((a,b)=> new Date(b)-new Date(a));
      for(const k of keys){
        const g=groups[k]; const gh=document.createElement('tr'); const title=new Date(k);
        gh.innerHTML=`<td colspan="10" style="color:#cad1ff; font-weight:700; background:#11163a; border:1px solid var(--border)">${title.toLocaleDateString()} — ${g.length} lệnh</td>`;
        body.appendChild(gh);
        for(const t of g){
          const tps=(t.tps||[]).filter(v=>v!==null).map(v=>Number(v).toFixed(4)).join(', ');
          const resTxt=t.result?`<span class="muted">${t.result.toUpperCase()}</span>`:'—';
          const pnlTxt=(t.pnl!=null)? `${Number(t.pnl).toFixed(2)} USDT (${Number(t.roi??0).toFixed(2)}%)` : '—';
          const tr=document.createElement('tr');
          tr.innerHTML=`
            <td class="nowrap">${new Date(t.ts).toLocaleString()}</td>
            <td>${t.symbol||'—'}</td>
            <td>${t.side}</td>
            <td class="nowrap">${t.E} / ${t.SL}</td>
            <td class="nowrap">${Number(t.Q).toFixed(6)} / ${Number(t.L).toFixed(2)}</td>
            <td>${Number(t.R).toFixed(2)}</td>
            <td>${tps||'—'}</td>
            <td>${resTxt}<div class="muted">${pnlTxt}</div></td>
            <td>${t.note||''}</td>
            <td class="nowrap">
              <button class="secondary" onclick="markRes('${t.id}','win')">Win</button>
              <button class="secondary" onclick="markRes('${t.id}','loss')">Loss</button>
              <button class="secondary" onclick="markRes('${t.id}',null)">Reset</button>
              <button class="secondary" onclick="editTrade('${t.id}')">Ghi chú</button>
              <button class="warn" onclick="delTrade('${t.id}')">Xoá</button>
            </td>`;
          body.appendChild(tr);
        }
      }
    }
    $('#btnFilter').onclick=renderJournal;
    $('#btnExportCSV').onclick=()=>{
      const list=loadJournal();
      const headers=['id','ts','symbol','side','M','E','SL','L','R','Q','N','dSL','moveSLPct','roiStopPct','tps','result','exitPrice','pnl','roi','rr','note'];
      const rows=[headers.join(',')];
      for(const t of list){
        const vals=headers.map(h=>{
          let v=t[h]; if(Array.isArray(v)) v=v.join('|'); if(v==null) v=''; const s=String(v).replace(/"/g,'""'); return `"${s}"`;
        });
        rows.push(vals.join(','));
      }
      const blob=new Blob([rows.join('\n')],{type:'text/csv'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='trade_journal.csv'; a.click(); URL.revokeObjectURL(url);
    };
    $('#btnExportJSON').onclick=()=>{
      const list=loadJournal(); const blob=new Blob([JSON.stringify(list,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='trade_journal.json'; a.click(); URL.revokeObjectURL(url);
    };
    $('#btnImport').onclick=()=> $('#importFile').click();
    $('#importFile').addEventListener('change', e=>{
      const f=e.target.files[0]; if(!f) return;
      const reader=new FileReader();
      reader.onload=()=>{
        try{ const arr=JSON.parse(reader.result); if(Array.isArray(arr)){ localStorage.setItem(KEY_JOURNAL, JSON.stringify(arr)); renderJournal(); alert('Đã nhập nhật ký.'); } else alert('File không hợp lệ.'); }
        catch(err){ alert('Lỗi đọc JSON.'); }
      };
      reader.readAsText(f); e.target.value='';
    });

    // PWA Install
    let deferredPrompt=null;
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault(); deferredPrompt=e; $('#btnInstall').style.display='inline-flex';
    });
    $('#btnInstall').onclick=async ()=>{
      if(!deferredPrompt) return; deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice; deferredPrompt=null; $('#btnInstall').style.display='none';
    };
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    }

    // Init
    restoreInputs(); renderJournal();
  </script>
</body>
</html>
